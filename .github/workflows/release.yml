name: Release

on:
  workflow_dispatch: {}

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '7.0.x'

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - run: dotnet restore

    - name: dotnet build
      run: dotnet build --no-restore --configuration Release

    - name: dotnet test
      run: dotnet test --no-build --configuration Release --verbosity normal

    - name: dotnet publish
      run: dotnet publish src/BHS.Web/BHS.Web.csproj --no-build --configuration Release

    - name: Upload
      uses: actions/upload-artifact@v3
      with:
        name: bhs-web-publish
        path: src/BHS.Web/bin/Release/net7.0/publish/
      
  deploy:
    name: Deploy
    if: github.repository_owner == 'JasonWeinzierl'
    runs-on: self-hosted
    needs: publish
    environment:
      name: production
      url: https://beltonhistoricalsociety.org/
    steps:

    - name: Clean
      run: rm -rf /srv/bhsspa/publish

    - name: Download
      uses: actions/download-artifact@v3
      with:
        name: bhs-web-publish
        path: /srv/bhsspa/publish

    - run: docker-compose up -d --build bhsspa
      working-directory: /srv
